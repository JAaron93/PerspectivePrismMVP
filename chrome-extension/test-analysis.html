<!DOCTYPE html>
<html>

<head>
    <title>Claim Analyzer Integration Test</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        console.log=(...args)=> {

            .pass {
                color: green;
                font-weight: bold;
            }

            .fail {
                color: red;
                font-weight: bold;
            }

            .log {
                margin-top: 10px;
                border-top: 1px solid #ccc;
                padding-top: 10px;
                white-space: pre-wrap;
                font-family: monospace;
            }

            #json-output {
                background: #f5f5f5;
                padding: 10px;
                border: 1px solid #ddd;
                margin-top: 10px;
            }
    </style>
</head>

<body>
    <h1>Claim Analyzer Integration Test</h1>
    <p>Testing analysis for Video ID: <span id="videoId">dQw4w9WgXcQ</span></p>
    <div id="status">Initializing...</div>
    <div id="results"></div>
    <pre id="json-output"></pre>
    <div class="log" id="log"></div>

    <script>
        // Mock chrome API
        const storage = {};
        window.chrome = {
            storage: {
                local: {
                    get: async (key) => {
                        if (key === null) return storage;
                        if (typeof key === 'string') return key in storage ? { [key]: storage[key] } : {};
                        if (Array.isArray(key)) {
                            const res = {};
                            key.forEach(k => { if (k in storage) res[k] = storage[k]; });
                            return res;
                        }
                        return storage;
                    },
                    set: async (items) => {
                        Object.assign(storage, items);
                        console.log('Storage set:', items);
                    },
                    remove: async (keys) => {
                        if (typeof keys === 'string') keys = [keys];
                        keys.forEach(k => delete storage[k]);
                        console.log('Storage removed:', keys);
                    }
                }
            },
            alarms: {
                create: async (name, info) => { console.log('Alarm created:', name, info); },
                onAlarm: { addListener: () => { } },
                getAll: async () => [],
                clear: async (name) => { console.log('Alarm cleared:', name); }
            },
            tabs: {
                query: (queryInfo, callback) => { callback([]); },
                sendMessage: async () => { }
            },
            runtime: {
                onMessage: { addListener: () => { } }
            }
        };

        // Mock console to capture logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const logDiv = document.getElementById('log');

        function appendLog(type, args) {
            const msg = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'ERROR' ? 'red' : 'black';
            logEntry.textContent = `[${type}] ${msg}`;
            logDiv.appendChild(logEntry);
        }
        }

        console.log = (...args) => {
            originalConsoleLog(...args);
            appendLog('INFO', args);
        };
        console.error = (...args) => {
            originalConsoleError(...args);
            appendLog('ERROR', args);
        };
    </script>

    <!-- Load client.js -->
    <script src="client.js"></script>

    <script>
        async function runTest() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const jsonOutput = document.getElementById('json-output');
            const videoId = 'dQw4w9WgXcQ'; // Rick Roll - should be safe and have captions

            try {
                statusDiv.textContent = 'Initializing Client...';
                const client = new PerspectivePrismClient('http://localhost:8000');

                statusDiv.textContent = 'Starting Analysis... (This may take a minute)';
                const escaped = (str) => {
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                };
                resultsDiv.innerHTML = `
                        <h3>Claims Found: ${result.data.claims.length}</h3>
                        <ul>
                            ${result.data.claims.map(c => `<li><b>${escaped(c.claim_text)}</b><br>Assessment: ${escaped(c.truth_profile.overall_assessment)}</li>`).join('')}
                        </ul>
                    `;
                jsonOutput.textContent = JSON.stringify(result.data, null, 2);
            } else {
                statusDiv.innerHTML = '<span class="fail">Analysis Failed</span>';
                resultsDiv.textContent = result.error;
                jsonOutput.textContent = JSON.stringify(result, null, 2);
            }

        } catch (e) {
            console.error('Test failed with exception:', e);
            statusDiv.innerHTML = '<span class="fail">Test Exception</span>';
            resultsDiv.textContent = e.message;
        }
        }

        // Run automatically
        if (typeof PerspectivePrismClient !== 'undefined') {
            runTest();
        } else {
            document.getElementById('status').innerHTML = '<span class="fail">Error: client.js not loaded</span>';
        }
    </script>
</body>

</html>