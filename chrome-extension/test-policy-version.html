<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Privacy Policy Version Test - Perspective Prism</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background-color: #f9f9f9;
      }
      .container {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #065fd4;
        margin-bottom: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }
      .btn-primary {
        background: #065fd4;
        color: white;
      }
      .btn-primary:hover {
        background: #0553bf;
      }
      .btn-secondary {
        background: #e5e5e5;
        color: #333;
      }
      .btn-secondary:hover {
        background: #d5d5d5;
      }
      .btn-danger {
        background: #d93025;
        color: white;
      }
      .btn-danger:hover {
        background: #c5221f;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        font-size: 14px;
      }
      .status.info {
        background: #e6f4ea;
        color: #137333;
      }
      .status.warning {
        background: #fef7e0;
        color: #b06000;
      }
      .status.error {
        background: #fce8e6;
        color: #d93025;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Privacy Policy Version Test</h1>
      <p>
        This page tests the privacy policy versioning functionality. Use the
        buttons below to simulate different scenarios.
      </p>

      <div class="test-section">
        <h2>Current State</h2>
        <div id="current-state" class="status info">Loading...</div>
        <button class="btn-secondary" onclick="checkCurrentState()">
          Refresh State
        </button>
      </div>

      <div class="test-section">
        <h2>Test Scenarios</h2>

        <h3>1. Simulate Version Mismatch</h3>
        <p>
          This will set the stored policy version to "0.9.0" to simulate an
          outdated version.
        </p>
        <button class="btn-primary" onclick="simulateVersionMismatch()">
          Simulate Old Version
        </button>

        <h3>2. Show Consent Dialog</h3>
        <p>
          This will manually trigger the consent dialog with version mismatch
          reason.
        </p>
        <button class="btn-primary" onclick="showConsentDialog()">
          Show Dialog
        </button>

        <h3>3. Check Version on Startup</h3>
        <p>
          This simulates what happens when the extension starts up and checks
          for version mismatches.
        </p>
        <button class="btn-primary" onclick="checkVersionOnStartup()">
          Check Version
        </button>

        <h3>4. View Version Logs</h3>
        <p>View the audit trail of policy version changes.</p>
        <button class="btn-secondary" onclick="viewVersionLogs()">
          View Logs
        </button>

        <h3>5. Reset to Current Version</h3>
        <p>Reset the stored policy version to the current version (1.0.0).</p>
        <button class="btn-danger" onclick="resetToCurrentVersion()">
          Reset Version
        </button>

        <h3>6. Clear All Data</h3>
        <p>Clear all consent and version data (for testing fresh install).</p>
        <button class="btn-danger" onclick="clearAllData()">
          Clear All Data
        </button>
      </div>

      <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="consent.js"></script>
    <script>
      const CURRENT_POLICY_VERSION = "1.0.0";

      function log(message, type = "info") {
        const resultsDiv = document.getElementById("test-results");
        const statusDiv = document.createElement("div");
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        resultsDiv.appendChild(statusDiv);
        resultsDiv.scrollTop = resultsDiv.scrollHeight;
      }

      async function checkCurrentState() {
        try {
          const result = await chrome.storage.sync.get(["consent"]);
          const consent = result.consent;

          const stateDiv = document.getElementById("current-state");

          if (!consent) {
            stateDiv.className = "status warning";
            stateDiv.innerHTML = `
              <strong>No Consent Data</strong><br>
              User has not given consent yet.
            `;
          } else {
            const isVersionMatch =
              consent.policyVersion === CURRENT_POLICY_VERSION;
            stateDiv.className = isVersionMatch
              ? "status info"
              : "status warning";
            stateDiv.innerHTML = `
              <strong>Consent Status:</strong> ${consent.given ? "Given" : "Not Given"}<br>
              <strong>Policy Version:</strong> ${consent.policyVersion || "Unknown"}<br>
              <strong>Current Version:</strong> ${CURRENT_POLICY_VERSION}<br>
              <strong>Version Match:</strong> ${isVersionMatch ? "✓ Yes" : "✗ No"}<br>
              <strong>Timestamp:</strong> ${new Date(consent.timestamp).toLocaleString()}
            `;
          }

          log("Current state refreshed", "info");
        } catch (error) {
          log(`Error checking state: ${error.message}`, "error");
        }
      }

      async function simulateVersionMismatch() {
        try {
          await chrome.storage.sync.set({
            consent: {
              given: true,
              timestamp: Date.now(),
              policyVersion: "0.9.0", // Old version
            },
          });
          log(
            "Simulated version mismatch: set stored version to 0.9.0",
            "info",
          );
          await checkCurrentState();
        } catch (error) {
          log(`Error simulating mismatch: ${error.message}`, "error");
        }
      }

      async function showConsentDialog() {
        try {
          const consentManager = new ConsentManager();
          consentManager.showConsentDialog(
            (allowed) => {
              if (allowed) {
                log("User accepted the updated policy", "info");
              } else {
                log("User declined the updated policy", "warning");
              }
              checkCurrentState();
            },
            {
              reason: "version_mismatch",
              storedVersion: "0.9.0",
              currentVersion: CURRENT_POLICY_VERSION,
            },
          );
          log("Consent dialog shown", "info");
        } catch (error) {
          log(`Error showing dialog: ${error.message}`, "error");
        }
      }

      async function checkVersionOnStartup() {
        try {
          const response = await chrome.runtime.sendMessage({
            type: "CHECK_POLICY_VERSION",
          });

          if (response.success) {
            if (response.hasMismatch) {
              log(
                `Version mismatch detected: ${response.storedVersion} -> ${response.currentVersion}`,
                "warning",
              );
            } else {
              log("No version mismatch detected", "info");
            }
          } else {
            log(`Error: ${response.error}`, "error");
          }
        } catch (error) {
          log(`Error checking version: ${error.message}`, "error");
        }
      }

      async function viewVersionLogs() {
        try {
          const result = await chrome.storage.local.get([
            "policy_version_logs",
          ]);
          const logs = result.policy_version_logs || [];

          if (logs.length === 0) {
            log("No version change logs found", "info");
          } else {
            log(`Found ${logs.length} version change log(s):`, "info");
            logs.forEach((entry, index) => {
              const logDiv = document.createElement("pre");
              logDiv.textContent = JSON.stringify(
                {
                  ...entry,
                  timestamp: new Date(entry.timestamp).toLocaleString(),
                },
                null,
                2,
              );
              document.getElementById("test-results").appendChild(logDiv);
            });
          }
        } catch (error) {
          log(`Error viewing logs: ${error.message}`, "error");
        }
      }

      async function resetToCurrentVersion() {
        try {
          await chrome.storage.sync.set({
            consent: {
              given: true,
              timestamp: Date.now(),
              policyVersion: CURRENT_POLICY_VERSION,
            },
          });
          log(`Reset to current version: ${CURRENT_POLICY_VERSION}`, "info");
          await checkCurrentState();
        } catch (error) {
          log(`Error resetting version: ${error.message}`, "error");
        }
      }

      async function clearAllData() {
        try {
          await chrome.storage.sync.remove(["consent"]);
          await chrome.storage.local.remove([
            "policy_version_logs",
            "policy_version_mismatch",
          ]);
          log("All consent and version data cleared", "info");
          await checkCurrentState();
        } catch (error) {
          log(`Error clearing data: ${error.message}`, "error");
        }
      }

      // Initialize
      checkCurrentState();
    </script>
  </body>
</html>
